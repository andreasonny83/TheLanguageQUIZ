<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../lq-dropdown/lq-dropdown.html">

<dom-module id="lq-login">
<style include="lq-shared-styles">
.hero {
	padding: 50px;
}
paper-card {
	width: 500px;

	--paper-card-actions: {
		text-align: right;
		@apply(--layout-center);
	}
}
.centered {
	max-width: 400px;
	margin-left: auto;
	margin-right: auto;
	text-align: center;
}
.secondary {
	height: 500px;
	width: 100%;
	background-color: #fff;
	overflow: auto;
}
footer {
	height: 200px;
}
@media (max-width: 639px) {}
</style>

<template>
	<div class="horizontal-section-container hero">
		<paper-card id="card_login" heading="Log In">
			<div class="card-content">
				<paper-input id="login_email" name="username" required label="E-mail" autofocus type="email" error-message="enter a valid email address" value="{{email}}" tabindex="1"></paper-input>
				<paper-input id="login_password" name="password" label="Password" required minlength=6 type="password" error-message="password must be 6 minimum characters" value="{{password}}" tabindex="2"></paper-input>
			</div>
			<div class="card-actions">
				<paper-button on-tap="login">
					<iron-icon icon="check" tabindex="3"></iron-icon>
					ok
				</paper-button>
			</div>

			<iron-a11y-keys
				id="login_keys"
				keys="enter"
				target="{{card_login}}"
				on-keys-pressed="login">
			</iron-a11y-keys>
		</paper-card>

	</div>
	<div class="horizontal-section-container hero">
		<paper-card id="card_register" heading="Register">
			<div class="card-content">
				<paper-input id="reg_name" type="text" label="User name*" required pattern="[a-zA-Z0-9]+" minlength=5 value="{{reg.name}}" error-message="letters and number only. Minimun of 5 charaters" tabindex="4"></paper-input>
				<paper-input id="reg_email" type="text" label="Email*" required value="{{reg.email}}" pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,4}$" error-message="enter a valid email address" tabindex="5"></paper-input>
				<paper-input id="reg_email_confirm" type="text" label="Re-enter email*" required value="{{reg.email_confirm}}" pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,4}$" error-message="email address doesn't match" tabindex="6"></paper-input>
				<paper-input id="reg_password" type="password" label="Password*" required pattern=".{6,}" value="{{reg.password}}" error-message="password must be 6 characters minimum." tabindex="7"></paper-input>
				<paper-input id="reg_password_confirm" type="password" required label="Re-enter password*" minlength=6 value="{{reg.password_confirm}}" error-message="password doesn't match" tabindex="8"></paper-input>
				<lq-dropdown id="language" title="I speak" selected-value={{reg.lang}} aria-disabled="false" tabindex="9"></lq-dropdown>
			</div>
			<div class="card-actions">
				<paper-button on-tap="register">
					<iron-icon icon="check" tabindex="10"></iron-icon>
					Register
				</paper-button>
			</div>

			<iron-a11y-keys
				id="register_keys"
				keys="enter"
				target="{{card_register}}"
				on-keys-pressed="register">
			</iron-a11y-keys>
		</paper-card>
	</div>

	<div class="horizontal-section-container">
		<div class="secondary">
			<h2 class='centered'>
				some images and product description here
			</h2>
		</div>
	</div>

	<footer>
		<h2 class='centered'>
			Footer
		</h2>
	</footer>

	<iron-ajax
		id="ajax_login"
		method="POST"
		handle-as="json"
		on-response="loginSucceed"
		on-error="loginFailed">
	</iron-ajax>

	<iron-ajax
		id="ajax_register"
		method="POST"
		handle-as="json"
		on-response="registerSucceed"
		on-error="registerFailed">
	</iron-ajax>

	<iron-ajax
		id="ajax_user"
		method="GET"
		headers={{apiKey}}
		handle-as="json"
		on-response="getUser"
		on-error="logOut">
	</iron-ajax>

</template>

<script>
Polymer({
	is: 'lq-login',

	behaviors: [
		Polymer.NeonAnimatableBehavior
	],

	properties: {
		reg: Object,

		animationConfig: {
			type: Object,
			value: function() {
				return {
					'entry': {
						name: 'fade-in-animation',
						node: this
					},
					'exit': {
						name: 'fade-out-animation',
						node: this
					}
				}
			}
		},
	},

	observers: [
		'_verifyName( reg.name )',
		'_verifyEmail( reg.email, reg.email_confirm )',
		'_verifyPassword( reg.password, reg.password_confirm )'
	],

	attached: function() {
		this.resetFields();

		lqApp.$.spinner.active = true; //loading
		this.apiKey            = lqApiKey;
		this.user_cookie       = lqApp.$.userCookie.readCookie();

		if ( this.user_cookie ) {
			this.$.ajax_user.url = apiDir + "user/" + this.user_cookie;
			return this.$.ajax_user.generateRequest();
		}

		lqApp.$.spinner.active = false; //loading
	},

	getUser: function( e ) {
		if ( e.detail.response.user ) {
			document.querySelector( 'app-router' ).go( '/' + this.user_cookie + '/home', { replace: true} );
		}
	},

	logOut: function() {
		lqApp.logOut();
	},

	/**
	 * Reset text fields and hide text fields errors
	 */
	resetFields: function() {
		this.email    = '';
		this.password = '';
		this.reg      = {
			name:             '',
			email:            '',
			email_confirm:    '',
			password:         '',
			password_confirm: '',
			lang:             'English'
		};

		this.$.reg_name.invalid = false;
		this.$.reg_email.invalid = false;
		this.$.reg_email_confirm.invalid = false;
		this.$.reg_password.invalid = false;
		this.$.reg_password_confirm.invalid = false;
	},

	_verifyName() {
		this.$.reg_name.validate();
	},

	_verifyEmail: function( email, email_confirm ) {
		this.$.reg_email.validate();

		// return error if the value is not matching the element requirements
		this.$.reg_email_confirm.validate();
		if ( this.$.reg_email_confirm.invalid ) return;

		// Verify if the entered email match the other one
		this.$.reg_email_confirm.invalid = true;

		if ( email === email_confirm ) {
			this.$.reg_email_confirm.invalid = false;
		}
	},

	_verifyPassword: function( password, password_confirm ) {
		this.$.reg_password.validate();

		// return error if the value is not matching the element requirements
		this.$.reg_password_confirm.validate();

		if ( this.$.reg_password_confirm.invalid ) return;

		// Verify if the entered password match the other one
		this.$.reg_password_confirm.invalid = true;

		if ( password === password_confirm ) {
			this.$.reg_password_confirm.invalid = false;
		}
	},

	register: function() {
		this.reg.lang = this.$.language.selectedValue;
		this.$.reg_name.validate();
		this.$.reg_email.validate();
		this.$.reg_email_confirm.validate();
		this.$.reg_password.validate();
		this.$.reg_password_confirm.validate();

		if ( ! this.reg.lang ) {
			fireToast( "Please, select your language first." );
			return;
		}

		if ( this.$.reg_name.invalid || this.$.reg_email.invalid || this.$.reg_email_confirm.invalid || this.$.reg_password.invalid || this.$.reg_password_confirm.invalid ) {
			fireToast( "Please, fix the wrong information and try again." );
			return;
		}


		lqApp.$.spinner.active = true; //loading

		var ajax_url              = apiDir + "register";
		this.$.ajax_register.url  = ajax_url;
		this.$.ajax_register.body = "name="              + encodeURIComponent( this.reg.name ) +
									"&email="            + encodeURIComponent( this.reg.email ) +
									"&email_confirm="    + encodeURIComponent( this.reg.email_confirm ) +
									"&password="         + encodeURIComponent( this.reg.password ) +
									"&password_confirm=" + encodeURIComponent( this.reg.password_confirm ) +
									"&language="         + encodeURIComponent( this.reg.lang );

		this.$.ajax_register.generateRequest();
	},

	/**
	 * Verify text fields
	 * then send the Ajax request to the API
	 */
	login: function() {
		this.$.login_email.validate();
		this.$.login_password.validate();

		if ( this.email.length > 0 && this.password.length > 0 && this.$.login_email.validate() && this.$.login_password.validate() ) {

			lqApp.$.spinner.active = true; //loading

			var ajax_url           = apiDir + "login";
			this.$.ajax_login.url  = ajax_url;
			this.$.ajax_login.body = "email=" + encodeURIComponent( this.email ) +
									 "&password=" + encodeURIComponent( this.password );

			this.$.ajax_login.generateRequest();
		}
		else {
			fireToast( "Please, check the entered details and try again." );
		}
	},

	registerSucceed: function() {
		lqApp.$.spinner.active = false; //loading
		this.resetFields();
		fireToast( "You are now registered." );
	},

	registerFailed: function() {
		lqApp.$.spinner.active = false; //loading
		this.resetFields();
		fireToast( "Please, check the entered details and try again." );
	},

	loginSucceed: function() {
		this.tryLogIn();
	},

	tryLogIn: function( n_try ) {
		// Try perform a log in for 3 times,
		// If fails, quit
		var n_try = n_try ? n_try : 0;

		if ( n_try >= 3 ) {
			lqApp.$.spinner.active = false; //loading
			fireToast( "It has been impossible to perform a log in. Please try again." );

			return;
		}

		var user_cookie = lqApp.$.userCookie.readCookie() ? lqApp.$.userCookie.readCookie() : null;

		if ( user_cookie ) {
			lqApp.$.router.go( '/' + user_cookie + '/home', { replace: true} );

			return;
		}

		this.async( function() {
			this.tryLogIn( n_try + 1 );
		}, 1500 );

	},

	loginFailed: function( e, response ) {
		var status = response.request.xhr.response ? response.request.xhr.response : null;
		lqApp.$.spinner.active = false; //loading

		if ( status && status.msg ) {
			fireToast( status.msg );

			return;
		}

		fireToast( "It has been impossible to receive any response from the server. Please, try again." );
	}
});
</script>
</dom-module>
