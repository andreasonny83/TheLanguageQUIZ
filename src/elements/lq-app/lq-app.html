<link rel="import" href="../polymer/polymer.html">

<dom-module id="lq-app">
<template>
	<style>
	:host {
		display: block;
		height: 100%;
	}
	</style>

	<app-router id="router" mode="hash">
		<app-route path="/" import="components/lq-login/lq-login.html"></app-route>
		<app-route path="/login" import="components/lq-login/lq-login.html"></app-route>
		<app-route path="/logout" import="components/lq-login/lq-logout.html"></app-route>
		<app-route path="/:uid/home" import="components/lq-page-home/lq-page-home.html"></app-route>
		<app-route path="*" redirect="/login"></app-route>
	</app-router>

	<paper-toast id="toast"></paper-toast>

	<polymer-cookie
		id="user_cookie"
		name="lq_user_id"
		time="14"
		format="d">
	</polymer-cookie>

	<iron-ajax
		id="ajax_user"
		method="POST"
		headers='{"LQ-API-KEY": "406cc6ed2c7471d7593461264c0db966"}'
		handle-as="json"
		on-error="logOut"
		on-response="getUser">
	</iron-ajax>

</template>

<script>
Polymer({
	is: 'lq-app',

	properties: {
		userCookie: {
			type: String,
			observer: "cookieUpdate"
		},

		user: {
			type: Object,
			observer: "userUpdate"
		}
	},

	attached: function() {
		var splash = document.querySelector( '#browser-sync-binding' );
		Polymer.Base.toggleAttribute( 'unresolved', true, splash );

		var elapsed = Date.now() - readyTime;
		console.log('Loading time: ' + elapsed);
		var t = 2500 - elapsed;
		// Minimum time for displaying the splashscreen
		// is set to 2 second
		if ( t < 2000 ) {
			t = 2000;
		}

		// this.async( this.update, t );
		console.log('APP is ready');
	},

	update: function() {
		console.log('update');

		// when update is triggered
		// we load a clean view like the app has been reloaded
		this.user = {
			'username': 'user',
			'pic': appDir + 'img/avatar.jpg'
		};

		this.userCookie = this.$.user_cookie.readCookie();
		this.async( function() {
			this.checkUser();
		}, 500 );
	},

	checkUser: function() {
		console.log( 'checkUser' );
		var uid    = document.querySelector( 'lq-page-home' ) ? document.querySelector( 'lq-page-home' ).uid : '';
		var router = document.querySelector( 'app-router' );
		// If a session is already started,
		// don't ask to log in again
		if ( this.userCookie && this.userCookie !== '' ) {
			console.log('going home');
			router.go( '/' + this.userCookie + '/home', { replace: true} );
		}
		else {
			router.go( '/login', { replace: true} );
		}
	},

	userUpdate: function() {
		// this.$.lqHome.$.lqProfile.user = this.$.lqPageFull.$.lqProfile.user = this.user;
	},

	cookieUpdate: function() {
		console.log('updating cookies');
		if ( this.userCookie && this.userCookie !== '' ) {
			this.$.ajax_user.url = apiDir + "user/" + this.userCookie;
			this.$.ajax_user.generateRequest();
		}
	},

	getUser: function( e ) {
		console.log('getUser');
		if ( e.detail.response.user ) {
			console.log('getUser, user information updated');
			this.user = e.detail.response.user;
			fireToast( "Welcome back " + this.user.username );
			// document.querySelector( 'app-router' ).go( '/home', { replace: true} );
		}
	},

	logOut: function() {
		lqApp.$.user_cookie.eraseCookie();
		fireToast( "You are now logged out" );
	},


});
</script>
</dom-module>
