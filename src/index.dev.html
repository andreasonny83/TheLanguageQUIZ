<!DOCTYPE html>
<html lang="en-GB">
<head>
	<meta charset="utf-8">
	<meta name="description" content="TheLanguageQUIZ">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="generator" content="TheLanguageQUIZ">
	<title>TheLanguageQUIZ</title>

	<!-- Chrome for Android theme color -->
	<meta name="theme-color" content="#6C96C3">

	<!-- Web Application Manifest -->
	<link rel="manifest" href="manifest.json">

	<!-- Tile color for Win8 -->
	<meta name="msapplication-TileColor" content="#6C96C3">

	<!-- Add to homescreen for Chrome on Android -->
	<meta name="mobile-web-app-capable" content="yes">
	<meta name="application-name" content="TheLanguageQUIZ">
	<link rel="icon" sizes="192x192" href="img/touch/chrome-touch-icon-192x192.png">

	<!-- Add to homescreen for Safari on iOS -->
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="apple-mobile-web-app-title" content="TheLanguageQUIZ">
	<link rel="apple-touch-icon" href="img/touch/apple-touch-icon.png">

	<!-- Tile icon for Win8 (144x144) -->
	<meta name="msapplication-TileImage" content="img/touch/ms-touch-icon-144x144-precomposed.png">

	<script>
		var readyTime = Date.now();
	</script>

	<!-- Stylesheet -->
	<link rel="stylesheet" href="css/main.min.css">

	<!-- Polymer -->
	<script src="components/webcomponentsjs/webcomponents-lite.min.js"></script>

	<!-- Web Components -->
	<link rel="import" href="elements.html" async>
</head>

<body class="fullbleed layout vertical">
	<div id="browser-sync-binding">
		<span class="primary">TheLanguageQUIZ is rendering</span>
		<span class="secondary">Please wait...</span>
	</div>

	<template is="dom-bind" id="lqApp">
		<app-router id="router" mode="hash">
			<app-route path="/login/" import="components/lq-pages/lq-login.html"></app-route>
			<app-route path="/:uid/" import="components/lq-pages/lq-main.html"></app-route>
			<app-route path="*" redirect="/login/"></app-route>
		</app-router>

		<paper-toast id="toast"></paper-toast>

		<lq-page-loading id="spinner"></lq-page-loading>

		<polymer-cookie
			id="userCookie"
			name="lq_user_id"
			time="14"
			format="d">
		</polymer-cookie>

		<iron-ajax
			id="ajax_logout"
			method="GET"
			handle-as="json"
			on-error="loggedOut"
			on-response="loggedOut">
		</iron-ajax>
	</template>

	<script>
	window.appDir   = "http://localhost:8888/TheLanguageQUIZ/dist/";
	window.apiDir   = "http://localhost:8888/TheLanguageQUIZ/dist/api/v1/";
	window.lqApiKey = {"LQ-API-KEY": "406cc6ed2c7471d7593461264c0db966"};

	window.addEventListener( 'WebComponentsReady', function() {
		var splash   = document.querySelector( '#browser-sync-binding' );
		var elapsed  = Date.now() - readyTime;
		window.toast = document.querySelector( '#toast' );
		window.lqApp = document.querySelector( '#lqApp' );

		// Hide the splashscreen
		Polymer.Base.toggleAttribute( 'unresolved', true, splash );
		console.log( 'APP is ready. Loading time: ' + elapsed );
	});

	/**
	 * Fire a toast message
	 * If busy, queue the request and retry after 500 milliseconds.
	 * @param String message
	 */
	lqApp.fireToast = function( message ) {
		if ( ! toast.visible ) {
			toast.text = message;
			toast.show();
		}
		else {
			setTimeout( function() {
				lqApp.fireToast( message );
			}, 500);
		}
	};

	/**
	 * Read the user cookie
	 * @return [String] The user uid
	 */
	lqApp.checkUserCookie = function() {
		return lqApp.$.userCookie.readCookie() ? lqApp.$.userCookie.readCookie() : null;
	},

	lqApp.logOut = function( message ) {
		if ( message ) lqApp.fireToast( message );

		lqApp.$.ajax_logout.url = apiDir + "logout";
		lqApp.$.userCookie.eraseCookie();
		lqApp.$.ajax_logout.generateRequest();
	};

	lqApp.loggedOut = function( e ) {
		lqApp.$.router.go( '/login/', { replace: true} );

		if ( lqApp.$.spinner.active ) lqApp.$.spinner.active = false; //loading

		lqApp.fireToast( e.detail.response.msg );
	};
	</script>
</body>
</html>
